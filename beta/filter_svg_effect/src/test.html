<!DOCTYPE html>
<html lang="en" class="no-js">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Costeira Profile</title>
		<link rel="stylesheet" type="text/css" href="css/base.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.1/gsap.min.js" integrity="sha512-Mf/xUqfWvDIr+1B6zfnIDIiG7XHzyP/guXUWgV6PgaQoIFeXkJQR5XWh9fqAiCiRCpemabt3naV4jhDWVnuYDQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
	</head>
	<body>
		<main>
			<div class="tobe_distorted">
				<figure class="thumb">
					<svg class="distort" width="350" height="450" viewBox="0 0 350 450" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
						<filter id="distortionFilter" data-type="turbulence">
							<feTurbulence type="fractalNoise" baseFrequency="0" numOctaves="1" result="warp" />
							<feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="250" in="SourceGraphic" />
						</filter>
						<image filter="url(#distortionFilter)" class="distort__img" x="50" y="50" xlink:href="img/profile.jpg" height="350" width="250"/>
					</svg>
				</figure>
			</div>
		</main>
		<script>


// import { gsap } from 'gsap';

class Item {

    constructor(el) {

        this.DOM = {el: el};
        this.DOM.thumb = this.DOM.el.querySelector('.thumb');
        
        this.DOM.thumbSVG = this.DOM.thumb.querySelector('.distort');
        this.DOM.SVGFilter = this.DOM.thumbSVG.querySelector('filter');
        this.DOM.SVGImage = this.DOM.thumbSVG.querySelector('image.distort__img');
        gsap.set(this.DOM.SVGImage, {transformOrigin: '50% 50%'});
        
        this.filterType = this.DOM.SVGFilter.dataset.type;
        this.DOM.feTurbulence = this.DOM.SVGFilter.querySelector('feTurbulence');
        this.DOM.feDisplacementMap = this.DOM.SVGFilter.querySelector('feDisplacementMap');
        
        this.primitiveValues = this.filterType === 'turbulence' ? {baseFrequency: 0} : {scale: 0};

        this.createHoverTimeline();
        this.initEvents();
    }
    
    initEvents() {
        this.onMouseEnterFn = () => this.mouseEnter();
        this.DOM.thumb.addEventListener('mouseenter', this.onMouseEnterFn);
        this.onMouseLeaveFn = () => this.mouseLeave();
        this.DOM.thumb.addEventListener('mouseleave', this.onMouseLeaveFn);
    }
    updateFilterValues() {
        this[this.filterType === 'turbulence' ? 'updateTurbulenceBaseFrequency' : 'updateDisplacementMapScale']();
    }
    updateTurbulenceBaseFrequency(val = this.primitiveValues.baseFrequency) {
        this.DOM.feTurbulence.setAttribute('baseFrequency', val);
    }
    updateDisplacementMapScale(val = this.primitiveValues.scale) {
        this.DOM.feDisplacementMap.setAttribute('scale', val);
    }

    createHoverTimeline() {
        this.tl = gsap.timeline({
            paused: true,
            defaults: {
                duration: 0.7,
                ease: 'power2'
            },
            onUpdate: () => this.updateFilterValues(),
            onReverseComplete: () => {
                if ( this.filterType === 'turbulence' ) {
                    this.primitiveValues.baseFrequency = 0;
                    this.updateFilterValues();
                }
            }
        });

        if ( this.filterType === 'turbulence' ) {
            this.tl.to(this.primitiveValues, { 
                startAt: {baseFrequency: 0.09},
                baseFrequency: 0
            }, 0);
        }
        else {
            this.tl.to(this.primitiveValues, { 
                startAt: {scale: 0},
                scale: 150
            }, 0);
        }
        
        if ( navigator.userAgent.indexOf('Firefox') == -1 ) {
            this.tl.to(this.DOM.SVGImage, {
                scale: 1.2,
            }, 0)
        }
    }

    // Start Animation
    mouseEnter() {
        this.tl.restart();
    }

    // End Animation
    mouseLeave() {
        this.tl.reverse();
    }
}

[...document.querySelectorAll('.tobe_distorted')].forEach(item => new Item(item));
        </script>
	</body>
</html>
